<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cycle Comp Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ダッシュボードエリア */
        #dashboard {
            background-color: #222;
            color: #fff;
            padding: 10px;
            /* height: 140px; */
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        /* 速度表示 */
        .metric-container {
            display: flex;
            justify-content: center;
            align-items: baseline;
        }
        .value { font-size: 3.5rem; font-weight: bold; font-family: monospace; line-height: 1; }
        .unit { font-size: 1rem; color: #aaa; margin-left: 5px;}

        /* コントロールボタン群 */
        .controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s;
        }

        #btn-record { background-color: #007bff; } /* 青色 (開始前) */
        #btn-record.recording { background-color: #dc3545; } /* 赤色 (記録中) */

        /* GPX入力は少し控えめに */
        .file-input-wrapper {
            flex: 1;
            background: #444;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .file-input-wrapper input {
            opacity: 0;
            position: absolute;
            width: 100%; height: 100%;
            cursor: pointer;
        }
        .file-input-label { font-size: 0.9rem; color: #ccc; pointer-events: none; }

        #status { font-size: 0.75rem; color: #aaa; text-align: center; margin-top: -5px; }

        /* 地図エリア */
        #map { flex-grow: 1; width: 100%; background: #ddd; position: relative; }

        /* 現在地へ戻るボタン (地図上にフロート表示) */
        #btn-center {
            position: relative;
            bottom: 0px;
            right: 0px;
            z-index: 999; /* Leafletの上に表示 */
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: white;
            color: #333;
            border: 2px solid #ccc;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        #btn-center:active { background-color: #eee; }

    </style>
</head>
<body>

    <div id="dashboard">
        <div class="metric-container">
            <div id="speed" class="value">0.0</div>
            <div class="unit">km/h</div>
        </div>
        <div id="status">GPS待機中...</div>

        <div class="controls">
            <button id="btn-record">計測開始</button>
            
            <div class="file-input-wrapper">
                <span class="file-input-label">GPX読込</span>
                <input type="file" id="gpxInput" accept=".gpx">
            </div>
        </div>
    </div>

    <div id="map">
        <button id="btn-center">◎</button>
    </div>

    <script>
        // --- 変数定義 ---
        let isRecording = false;    // 記録中かどうか
        let isAutoCentering = true; // 現在地を自動追従するかどうか
        let currentPos = null;      // 最新の現在地座標
        const trackPath = [];       // 軌跡データ配列

        // --- DOM要素 ---
        const speedEl = document.getElementById('speed');
        const statusEl = document.getElementById('status');
        const btnRecord = document.getElementById('btn-record');
        const btnCenter = document.getElementById('btn-center');
        const gpxInput = document.getElementById('gpxInput');

        // --- 1. 地図初期化 ---
        const map = L.map('map', { zoomControl: false }).setView([35.6812, 139.7671], 15);
        L.control.zoom({ position: 'topright' }).addTo(map); // ズームボタン位置調整
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OSM'
        }).addTo(map);

        let myMarker = null;
        const trackLine = L.polyline([], {color: '#ff0000', weight: 5, opacity: 0.8}).addTo(map);
        let plannedRouteLine = null;

        // --- 2. ボタン操作ロジック ---

        // (A) 計測開始・終了ボタン
        btnRecord.addEventListener('click', () => {
            if (!isRecording) {
                // 開始処理
                const confirmStart = trackPath.length > 0 ? confirm("新しい記録を開始しますか？(前の軌跡は消えます)") : true;
                if (!confirmStart) return;

                isRecording = true;
                
                // 軌跡リセット
                trackPath.length = 0;
                trackLine.setLatLngs([]);
                
                // UI変更
                btnRecord.textContent = "計測終了";
                btnRecord.classList.add('recording'); // 赤くする
                
                // 自動追従をONにして現在地へ
                isAutoCentering = true;
                if (currentPos) map.panTo(currentPos);

            } else {
                // 終了処理
                isRecording = false;
                
                // UI変更
                btnRecord.textContent = "計測開始";
                btnRecord.classList.remove('recording'); // 青に戻す
            }
        });

        // (B) 現在地へ戻るボタン
        btnCenter.addEventListener('click', () => {
            isAutoCentering = true;
            if (currentPos) {
                map.panTo(currentPos);
                // 必要ならズームレベルも戻す
                // map.setView(currentPos, 15); 
            }
        });

        // (C) 地図を手動で動かした時の検知
        // 'dragstart' はユーザーが指でドラッグし始めた時に発火
        map.on('dragstart', () => {
            isAutoCentering = false; // 自動追従を解除
        });


        // --- 3. GPS処理 ---
        const geoOptions = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };

        function success(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const accuracy = pos.coords.accuracy;
            let speedKmh = (pos.coords.speed || 0) * 3.6;
            if (speedKmh < 0) speedKmh = 0;

            // 状態更新
            currentPos = [lat, lng];
            speedEl.textContent = speedKmh.toFixed(1);
            statusEl.textContent = `精度: ${Math.round(accuracy)}m`;

            // マーカー更新 (記録中じゃなくても現在地は表示)
            if (!myMarker) {
                myMarker = L.marker(currentPos).addTo(map);
            } else {
                myMarker.setLatLng(currentPos);
            }

            // 【重要】記録中のみ軌跡を追加
            if (isRecording) {
                trackPath.push(currentPos);
                trackLine.setLatLngs(trackPath);
            }

            // 【重要】自動追従ONのときのみ地図を動かす
            if (isAutoCentering) {
                map.panTo(currentPos);
            }
        }

        function error(err) {
            statusEl.textContent = "GPS待機中...";
        }

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(success, error, geoOptions);
        }

        // --- 4. GPX読み込み ---
        gpxInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                parseGPX(e.target.result);
            };
            reader.readAsText(file);
        });

        function parseGPX(gpxText) {
            if (plannedRouteLine) map.removeLayer(plannedRouteLine);
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(gpxText, "text/xml");
            const trkpts = xmlDoc.getElementsByTagName("trkpt");
            const routeCoords = [];
            for (let i = 0; i < trkpts.length; i++) {
                routeCoords.push([parseFloat(trkpts[i].getAttribute("lat")), parseFloat(trkpts[i].getAttribute("lon"))]);
            }
            if (routeCoords.length > 0) {
                plannedRouteLine = L.polyline(routeCoords, {color: '#3388ff', weight: 6, opacity: 0.6}).addTo(map);
                map.fitBounds(plannedRouteLine.getBounds());
                // GPX読み込み直後は全体を見たいはずなので、自動追従は一旦OFFにするのが親切かも（お好みで）
                isAutoCentering = false; 
            } else {
                alert("ルートが見つかりませんでした");
            }
        }

        // --- 5. Wake Lock ---
        let wakeLock = null;
        async function requestWakeLock() {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
        }
        document.addEventListener('click', requestWakeLock);
        requestWakeLock();

    </script>
</body>
</html>

